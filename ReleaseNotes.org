#+STARTUP: showeverything
* USDA Signature update
** Shut down and back up production
** Iterations
*** #1: copy db from production to dev; perform following ops locally
*** #2: perform following ops on production
** Merge to master
** COMMENT Database changes
ALTER TABLE UsdaEligibleNextDistro RENAME TO UsdaEligibleNextDistroHistory;

CREATE TABLE UsdaEligibleHistory
(
  distribution              VARCHAR REFERENCES DistributionPeriod
                                ON DELETE CASCADE
                                ON UPDATE CASCADE,
  family_name               VARCHAR REFERENCES Client
                                ON DELETE CASCADE
                                ON UPDATE CASCADE,
  usda_eligible             VARCHAR NOT NULL DEFAULT '',
  PRIMARY KEY (distribution, family_name)
);

INSERT INTO UsdaEligibleHistory
    (distribution, family_name, usda_eligible)
  SELECT
      (SELECT MAX(start_date) FROM DistributionPeriod) AS distribution,
      family_name,
      usda_eligible
    FROM Client
    WHERE length(usda_eligible) > 0;

DROP TRIGGER IF EXISTS tr_ai_Client;
CREATE TRIGGER tr_ai_Client
AFTER INSERT ON Client
BEGIN
  REPLACE INTO UsdaEligibleHistory (
      distribution,
      family_name,
      usda_eligible
    ) VALUES (
      (SELECT MAX(start_date) FROM DistributionPeriod),
      new.family_name,
      new.usda_eligible
    );

  REPLACE INTO UsdaEligibleNextDistroHistory (
      distribution,
      family_name,
      usda_eligible_next_distro
    ) VALUES (
      (SELECT MAX(start_date) FROM DistributionPeriod),
      new.family_name,
      new.usda_eligible_next_distro
    );

  -- No need to maintain null entries here
  DELETE FROM UsdaEligibleNextDistroHistory
    WHERE
      family_name = new.family_name
      AND distribution = (SELECT MAX(start_date) FROM DistributionPeriod)
      AND usda_eligible_next_distro IS NULL;
END;

-- ... and then for an update of an existing client
DROP TRIGGER IF EXISTS tr_au_Client;
CREATE TRIGGER tr_au_Client
AFTER UPDATE ON Client
BEGIN
  REPLACE INTO UsdaEligibleHistory (
      distribution,
      family_name,
      usda_eligible
    ) VALUES (
      (SELECT MAX(start_date) FROM DistributionPeriod),
      new.family_name,
      new.usda_eligible
    );

  REPLACE INTO UsdaEligibleNextDistroHistory (
      distribution,
      family_name,
      usda_eligible_next_distro
    ) VALUES (
      (SELECT MAX(start_date) FROM DistributionPeriod),
      new.family_name,
      new.usda_eligible_next_distro
    );

  DELETE FROM UsdaEligibleNextDistroHistory
    WHERE
      family_name = new.family_name
      AND distribution = (SELECT MAX(start_date) FROM DistributionPeriod)
      AND usda_eligible_next_distro IS NULL;
END;


** Reports changes
*** DELETE FROM Report;
*** Add the entirety of reports.sql
** mkdir -p <toplevel>/reports
** Install new software
** Run new software
